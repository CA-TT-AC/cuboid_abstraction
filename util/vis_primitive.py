import numpy as np
import quaternion

# todo: use new colormap
colormap = np.array([[0.000000, 0.000000, 0.515625], [0.000000, 0.000000, 0.531250], [0.000000, 0.000000, 0.546875], [0.000000, 0.000000, 0.562500], [0.000000, 0.000000, 0.578125], [0.000000, 0.000000, 0.593750], [0.000000, 0.000000, 0.609375], [0.000000, 0.000000, 0.625000], [0.000000, 0.000000, 0.640625], [0.000000, 0.000000, 0.656250], [0.000000, 0.000000, 0.671875], [0.000000, 0.000000, 0.687500], [0.000000, 0.000000, 0.703125], [0.000000, 0.000000, 0.718750], [0.000000, 0.000000, 0.734375], [0.000000, 0.000000, 0.750000], [0.000000, 0.000000, 0.765625], [0.000000, 0.000000, 0.781250], [0.000000, 0.000000, 0.796875], [0.000000, 0.000000, 0.812500], [0.000000, 0.000000, 0.828125], [0.000000, 0.000000, 0.843750], [0.000000, 0.000000, 0.859375], [0.000000, 0.000000, 0.875000], [0.000000, 0.000000, 0.890625], [0.000000, 0.000000, 0.906250], [0.000000, 0.000000, 0.921875], [0.000000, 0.000000, 0.937500], [0.000000, 0.000000, 0.953125], [0.000000, 0.000000, 0.968750], [0.000000, 0.000000, 0.984375], [0.000000, 0.000000, 1.000000], [0.000000, 0.015625, 1.000000], [0.000000, 0.031250, 1.000000], [0.000000, 0.046875, 1.000000], [0.000000, 0.062500, 1.000000], [0.000000, 0.078125, 1.000000], [0.000000, 0.093750, 1.000000], [0.000000, 0.109375, 1.000000], [0.000000, 0.125000, 1.000000], [0.000000, 0.140625, 1.000000], [0.000000, 0.156250, 1.000000], [0.000000, 0.171875, 1.000000], [0.000000, 0.187500, 1.000000], [0.000000, 0.203125, 1.000000], [0.000000, 0.218750, 1.000000], [0.000000, 0.234375, 1.000000], [0.000000, 0.250000, 1.000000], [0.000000, 0.265625, 1.000000], [0.000000, 0.281250, 1.000000], [0.000000, 0.296875, 1.000000], [0.000000, 0.312500, 1.000000], [0.000000, 0.328125, 1.000000], [0.000000, 0.343750, 1.000000], [0.000000, 0.359375, 1.000000], [0.000000, 0.375000, 1.000000], [0.000000, 0.390625, 1.000000], [0.000000, 0.406250, 1.000000], [0.000000, 0.421875, 1.000000], [0.000000, 0.437500, 1.000000], [0.000000, 0.453125, 1.000000], [0.000000, 0.468750, 1.000000], [0.000000, 0.484375, 1.000000], [0.000000, 0.500000, 1.000000], [0.000000, 0.515625, 1.000000], [0.000000, 0.531250, 1.000000], [0.000000, 0.546875, 1.000000], [0.000000, 0.562500, 1.000000], [0.000000, 0.578125, 1.000000], [0.000000, 0.593750, 1.000000], [0.000000, 0.609375, 1.000000], [0.000000, 0.625000, 1.000000], [0.000000, 0.640625, 1.000000], [0.000000, 0.656250, 1.000000], [0.000000, 0.671875, 1.000000], [0.000000, 0.687500, 1.000000], [0.000000, 0.703125, 1.000000], [0.000000, 0.718750, 1.000000], [0.000000, 0.734375, 1.000000], [0.000000, 0.750000, 1.000000], [0.000000, 0.765625, 1.000000], [0.000000, 0.781250, 1.000000], [0.000000, 0.796875, 1.000000], [0.000000, 0.812500, 1.000000], [0.000000, 0.828125, 1.000000], [0.000000, 0.843750, 1.000000], [0.000000, 0.859375, 1.000000], [0.000000, 0.875000, 1.000000], [0.000000, 0.890625, 1.000000], [0.000000, 0.906250, 1.000000], [0.000000, 0.921875, 1.000000], [0.000000, 0.937500, 1.000000], [0.000000, 0.953125, 1.000000], [0.000000, 0.968750, 1.000000], [0.000000, 0.984375, 1.000000], [0.000000, 1.000000, 1.000000], [0.015625, 1.000000, 0.984375], [0.031250, 1.000000, 0.968750], [0.046875, 1.000000, 0.953125], [0.062500, 1.000000, 0.937500], [0.078125, 1.000000, 0.921875], [0.093750, 1.000000, 0.906250], [0.109375, 1.000000, 0.890625], [0.125000, 1.000000, 0.875000], [0.140625, 1.000000, 0.859375], [0.156250, 1.000000, 0.843750], [0.171875, 1.000000, 0.828125], [0.187500, 1.000000, 0.812500], [0.203125, 1.000000, 0.796875], [0.218750, 1.000000, 0.781250], [0.234375, 1.000000, 0.765625], [0.250000, 1.000000, 0.750000], [0.265625, 1.000000, 0.734375], [0.281250, 1.000000, 0.718750], [0.296875, 1.000000, 0.703125], [0.312500, 1.000000, 0.687500], [0.328125, 1.000000, 0.671875], [0.343750, 1.000000, 0.656250], [0.359375, 1.000000, 0.640625], [0.375000, 1.000000, 0.625000], [0.390625, 1.000000, 0.609375], [0.406250, 1.000000, 0.593750], [0.421875, 1.000000, 0.578125], [0.437500, 1.000000, 0.562500], [0.453125, 1.000000, 0.546875], [0.468750, 1.000000, 0.531250], [0.484375, 1.000000, 0.515625], [0.500000, 1.000000, 0.500000], [0.515625, 1.000000, 0.484375], [0.531250, 1.000000, 0.468750], [0.546875, 1.000000, 0.453125], [0.562500, 1.000000, 0.437500], [0.578125, 1.000000, 0.421875], [0.593750, 1.000000, 0.406250], [0.609375, 1.000000, 0.390625], [0.625000, 1.000000, 0.375000], [0.640625, 1.000000, 0.359375], [0.656250, 1.000000, 0.343750], [0.671875, 1.000000, 0.328125], [0.687500, 1.000000, 0.312500], [0.703125, 1.000000, 0.296875], [0.718750, 1.000000, 0.281250], [0.734375, 1.000000, 0.265625], [0.750000, 1.000000, 0.250000], [0.765625, 1.000000, 0.234375], [0.781250, 1.000000, 0.218750], [0.796875, 1.000000, 0.203125], [0.812500, 1.000000, 0.187500], [0.828125, 1.000000, 0.171875], [0.843750, 1.000000, 0.156250], [0.859375, 1.000000, 0.140625], [0.875000, 1.000000, 0.125000], [0.890625, 1.000000, 0.109375], [0.906250, 1.000000, 0.093750], [0.921875, 1.000000, 0.078125], [0.937500, 1.000000, 0.062500], [0.953125, 1.000000, 0.046875], [0.968750, 1.000000, 0.031250], [0.984375, 1.000000, 0.015625], [1.000000, 1.000000, 0.000000], [1.000000, 0.984375, 0.000000], [1.000000, 0.968750, 0.000000], [1.000000, 0.953125, 0.000000], [1.000000, 0.937500, 0.000000], [1.000000, 0.921875, 0.000000], [1.000000, 0.906250, 0.000000], [1.000000, 0.890625, 0.000000], [1.000000, 0.875000, 0.000000], [1.000000, 0.859375, 0.000000], [1.000000, 0.843750, 0.000000], [1.000000, 0.828125, 0.000000], [1.000000, 0.812500, 0.000000], [1.000000, 0.796875, 0.000000], [1.000000, 0.781250, 0.000000], [1.000000, 0.765625, 0.000000], [1.000000, 0.750000, 0.000000], [1.000000, 0.734375, 0.000000], [1.000000, 0.718750, 0.000000], [1.000000, 0.703125, 0.000000], [1.000000, 0.687500, 0.000000], [1.000000, 0.671875, 0.000000], [1.000000, 0.656250, 0.000000], [1.000000, 0.640625, 0.000000], [1.000000, 0.625000, 0.000000], [1.000000, 0.609375, 0.000000], [1.000000, 0.593750, 0.000000], [1.000000, 0.578125, 0.000000], [1.000000, 0.562500, 0.000000], [1.000000, 0.546875, 0.000000], [1.000000, 0.531250, 0.000000], [1.000000, 0.515625, 0.000000], [1.000000, 0.500000, 0.000000], [1.000000, 0.484375, 0.000000], [1.000000, 0.468750, 0.000000], [1.000000, 0.453125, 0.000000], [1.000000, 0.437500, 0.000000], [1.000000, 0.421875, 0.000000], [1.000000, 0.406250, 0.000000], [1.000000, 0.390625, 0.000000], [1.000000, 0.375000, 0.000000], [1.000000, 0.359375, 0.000000], [1.000000, 0.343750, 0.000000], [1.000000, 0.328125, 0.000000], [1.000000, 0.312500, 0.000000], [1.000000, 0.296875, 0.000000], [1.000000, 0.281250, 0.000000], [1.000000, 0.265625, 0.000000], [1.000000, 0.250000, 0.000000], [1.000000, 0.234375, 0.000000], [1.000000, 0.218750, 0.000000], [1.000000, 0.203125, 0.000000], [1.000000, 0.187500, 0.000000], [1.000000, 0.171875, 0.000000], [1.000000, 0.156250, 0.000000], [1.000000, 0.140625, 0.000000], [1.000000, 0.125000, 0.000000], [1.000000, 0.109375, 0.000000], [1.000000, 0.093750, 0.000000], [1.000000, 0.078125, 0.000000], [1.000000, 0.062500, 0.000000], [1.000000, 0.046875, 0.000000], [1.000000, 0.031250, 0.000000], [1.000000, 0.015625, 0.000000], [1.000000, 0.000000, 0.000000], [0.984375, 0.000000, 0.000000], [0.968750, 0.000000, 0.000000], [0.953125, 0.000000, 0.000000], [0.937500, 0.000000, 0.000000], [0.921875, 0.000000, 0.000000], [0.906250, 0.000000, 0.000000], [0.890625, 0.000000, 0.000000], [0.875000, 0.000000, 0.000000], [0.859375, 0.000000, 0.000000], [0.843750, 0.000000, 0.000000], [0.828125, 0.000000, 0.000000], [0.812500, 0.000000, 0.000000], [0.796875, 0.000000, 0.000000], [0.781250, 0.000000, 0.000000], [0.765625, 0.000000, 0.000000], [0.750000, 0.000000, 0.000000], [0.734375, 0.000000, 0.000000], [0.718750, 0.000000, 0.000000], [0.703125, 0.000000, 0.000000], [0.687500, 0.000000, 0.000000], [0.671875, 0.000000, 0.000000], [0.656250, 0.000000, 0.000000], [0.640625, 0.000000, 0.000000], [0.625000, 0.000000, 0.000000], [0.609375, 0.000000, 0.000000], [0.593750, 0.000000, 0.000000], [0.578125, 0.000000, 0.000000], [0.562500, 0.000000, 0.000000], [0.546875, 0.000000, 0.000000], [0.531250, 0.000000, 0.000000], [0.515625, 0.000000, 0.000000], [0.500000, 0.000000, 0.000000]])

cube_vert = np.array([[0.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 1.0], [1.0, 1.0, 0.0], [1.0, 1.0, 1.0]], dtype=float)
cube_vert = cube_vert * 2 - 1

cube_face = np.array([[1, 3, 7, 5], [1, 2, 4, 3], [3, 4, 8, 7], [5, 7, 8, 6], [1, 5, 6, 2], [2, 6, 8, 4]])


def save_parts(cube_params, output_file):
  n_part = np.shape(cube_params)[0]
  mtl_filename = output_file.replace('.obj', '.mtl')
  with open(mtl_filename, 'w') as f:
    for i in range(n_part):
      part_color = colormap[i * int(np.floor(256 / n_part))]
      f.write('newmtl m{}\nKd {} {} {}\nKa 0 0 0\n'.format(i, part_color[0], part_color[1], part_color[2]))

  with open(output_file, 'w') as f:
    vert_offset = 0
    n_vert = np.shape(cube_vert)[0]
    f.write('mtllib {}\n'.format(mtl_filename.split('/')[-1]))
    for i in range(n_part):
      verts = cube_vert
      scale = cube_params[i][0:3]
      rot = cube_params[i][3:7]
      translation = cube_params[i][7:10]
      verts = verts * scale
      # print(rot)
      quat = np.quaternion(rot[0], rot[1], rot[2], rot[3])
      rotation = quaternion.as_rotation_matrix(quat)
      verts = np.transpose(np.matmul(rotation, np.transpose(verts)))
      verts = verts + translation

      faces = cube_face + vert_offset
      f.write('# {} {} {} {} {} {} {} {} {} {}\n'.format(
          scale[0], scale[1], scale[2],
          rot[0], rot[1], rot[2], rot[3],
          translation[0], translation[1], translation[2])
      )
      f.write('usemtl m{}\n'.format(i))
      for j in range(n_vert):
        sigma = 0.1
        f.write('v {} {} {}\n'.format(verts[j][0], verts[j][1], verts[j][2]))
      for j in range(np.shape(cube_face)[0]):
        f.write('f {} {} {} {}\n'.format(faces[j][0], faces[j][1], faces[j][2], faces[j][3]))
      vert_offset += n_vert
